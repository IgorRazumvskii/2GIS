<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>✨ iPhone 14 с картой и анимацией ✨</title>
  <link rel="stylesheet" href="https://public.codepenassets.com/css/reset-2.0.min.css">
  <link rel="stylesheet" href="./style.css">
  <script src="https://mapgl.2gis.com/api/js/v1"></script>
  <style>
    /* Стили из функциональной части */
    #ui {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 9999;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      padding: 8px;
      font-family: sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      font-size: 12px;
    }
    #msg { margin-bottom:6px; color:#222; }
    #speedDisplay { color:#333; margin-top:4px; }
    #resetBtn { padding:6px 8px; cursor:pointer; margin-bottom: 4px; }
    .marker-dot {
      display:flex; align-items:center; justify-content:center;
      width:22px; height:22px; border-radius:50%;
      color:#fff; font-weight:700; font-size:12px;
      box-shadow:0 1px 3px rgba(0,0,0,0.4); border:2px solid #fff;
    }
    
    /* Кнопки из функционала */
#lostBtn {
  background: #ff3300;
  color: white;
  font-size: 24px;
  font-weight: bold;
  padding: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  width: 150px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: absolute;
  right: 50px;
  bottom: 50px;
  z-index: 1000;
}

#startBtn {
  background: #1EB83C;
  color: white;
  font-size: 24px;
  font-weight: bold;
  padding: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  width: 150px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  line-height: 1.2;
  transition: all 0.3s ease;
  position: absolute;
  left: 50px;
  bottom: 50px;
  z-index: 1000;
}
.fab-group{
  position: absolute;
  right: 30px;
  top: 550px;

}
.phone {
    width: 450px;
    height: 900px;   
}
  </style>
</head>

<body class="">
    <div id="ui">
    <div id="msg">Кликните по карте: <b>1</b> — старт (A), <b>2</b> — финиш (B).</div>
    <button id="resetBtn">Сбросить точки</button>
    <div id="speedDisplay">Скорость: 0 км/ч</div>
  </div>
  <div class="scene">
    <div class="phone-con">
      <div class="phone">

        <!-- Блоки отображения боковых кнопок на модельке -->
        <div class="buttons">
          <div class="left">
            <div class="button"></div>
            <div class="button"></div>
            <div class="button"></div>
          </div>
          <div class="right">
            <div class="button"></div>
          </div>
        </div>

        <!-- Блок отображения камеры на модельке -->
        <div class="camera"></div>
        <div class="screen-container">
          <div class="notch-container" tabindex="0">
            <div class="notch">
              <div class="content">
                <div class="left">
                  <div class="tile"></div>
                  <div class="text"></div>
                </div>
                <div class="right"></div>
                <div class="bar">
                  <div class="duration"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Блок отображения экрана -->
           
          <div class="screen">
            <!-- Функциональная часть карты -->
            <div id="container" style="width:100%; height:100%; position:relative;"></div>
          
            
    <!-- FAB кнопки управления картой -->
    <div class="fab-group">
        <div id="zoomIn" class="fab">＋</div>
        <div id="zoomOut" class="fab">−</div>
        <div id="loc" class="fab">◎</div>
    </div>
    
    <!-- Горизонтальные кнопки -->
    <div class="horizontal-buttons">
        <button id="lostBtn" class="btn-lost">Потерялся</button>
        <button id="startBtn" class="btn-start">В путь</button>
    </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ------------- ФУНКЦИОНАЛЬНАЯ ЧАСТЬ С КАРТОЙ И АНИМАЦИЕЙ -------------
    (function () {
      const BACKEND_URL = 'http://localhost:8000';
      const containerMsg = document.getElementById('msg');
      const speedDisplay = document.getElementById('speedDisplay');
      const resetBtn = document.getElementById('resetBtn');
      let curB;
      let startAnimation = false;
      let isLost = false;
      let lastPoint = { lon: 0.0, lat: 0.0 };
      
      function logUI(text) {
        containerMsg.innerHTML = text;
        console.log(text);
      }

      async function sendPointsToBackend(points) {
        try {
          const resp = await fetch(`${BACKEND_URL}/points`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ points })
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return await resp.json();
        } catch (err) {
          console.error('Ошибка отправки на backend:', err);
          logUI('Ошибка запроса к backend — смотрите консоль');
          return null;
        }
      }

      function createPoint(type, lon, lat) { return { type, lon, lat }; }

      const map = new mapgl.Map('container', {
        center: [37.62, 55.75],
        zoom: 13,
        key: '285d3b2b-96ab-4fe5-a700-12ef370d7085',
      });

      let pointsArray = [];
      let clickCount = 0;
      let markerObjs = [];
      let routePolylines = [];
      let animMarker = null;
      let animHandle = null;

      function clearRoute() {
        routePolylines.forEach(p => { try { p.destroy(); } catch(e){} });
        routePolylines = [];
        if (animMarker) { try { animMarker.destroy(); } catch(e){}; animMarker = null; }
        if (animHandle) { cancelAnimationFrame(animHandle); animHandle = null; }
        speedDisplay.innerText = 'Скорость: 0 км/ч';
      }

      function clearAll() {
        if (animHandle) {
          cancelAnimationFrame(animHandle);
          animHandle = null;
        }
        
        startAnimation = false;
        isLost = false;
        
        routePolylines.forEach(polyline => {
          try { polyline.destroy(); } catch (e) { console.error('Error destroying polyline:', e); }
        });
        routePolylines = [];
        
        markerObjs.forEach(marker => {
          try { marker.destroy(); } catch (e) { console.error('Error destroying marker:', e); }
        });
        markerObjs = [];
        
        if (animMarker) {
          try { animMarker.destroy(); } catch (e) { console.error('Error destroying anim marker:', e); }
          animMarker = null;
        }
        
        pointsArray = [];
        clickCount = 0;
        
        speedDisplay.innerText = 'Скорость: 0 км/ч';
        logUI('Все очищено. Можете начать заново.');
      }

      document.getElementById('lostBtn').addEventListener('click', () => {
        isLost = true;
      });
// Добавь этот код где-нибудь после инициализации map
document.getElementById('zoomIn').addEventListener('click', () => {
    try { if (typeof map.getZoom === 'function' && typeof map.setZoom === 'function') map.setZoom(map.getZoom() + 1); } catch (_) { }
});
document.getElementById('zoomOut').addEventListener('click', () => {
    try { if (typeof map.getZoom === 'function' && typeof map.setZoom === 'function') map.setZoom(map.getZoom() - 1); } catch (_) { }
});
document.getElementById('loc').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Геолокация недоступна');
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        try { map.setCenter([lon, lat]); map.setZoom(15); } catch (e) { console.warn(e); }
    }, err => alert('Не удалось получить координаты: ' + (err.message || err)));
});
      async function start(){
        startAnimation = true;
        lastTime = performance.now();
        animHandle = requestAnimationFrame(step);
      }

      document.getElementById('startBtn').addEventListener('click', start);
      resetBtn.addEventListener('click', clearAll);

      function createHtmlMarker(coords, el) {
        try { return new mapgl.HtmlMarker(map, { coordinates: coords, html: el }); }
        catch(err1){ try { return new mapgl.HtmlMarker({ map: map, coordinates: coords, html: el }); }
        catch(err2){ const m=new mapgl.Marker({map,coordinates:coords}); if(typeof m.setElement==='function') m.setElement(el); return m; } }
      }

      function makeDot(color,label) {
        const d=document.createElement('div'); d.className='marker-dot';
        d.style.background=color; d.style.width=d.style.height='22px';
        d.style.lineHeight='22px'; d.style.border='2px solid white';
        d.style.boxShadow='0 1px 3px rgba(0,0,0,0.4)'; d.style.fontSize='12px';
        d.style.userSelect='none'; d.innerText=label||''; return d;
      }

      function getDistance([lon1,lat1],[lon2,lat2]){
        const R=6371000, φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180;
        const Δφ=(lat2-lat1)*Math.PI/180, Δλ=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
        const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        return R*c;
      }

      map.on('load', () => logUI('Кликните по карте: <b>1</b> — старт (A), <b>2</b> — финиш (B).'));

      map.on('click', async (e) => {
        let [lng,lat] = Array.isArray(e.lngLat) ? e.lngLat : [e.lngLat.lng, e.lngLat.lat];
        clickCount++;
        const type = clickCount===1?'start':'stop', label=clickCount===1?'A':'B';
        pointsArray.push(createPoint(type, lng, lat));
        const dot = makeDot(type==='start'?'green':'red', label);
        const m = createHtmlMarker([lng,lat], dot);
        if(m) markerObjs.push(m);

        if(clickCount===1) logUI('Выбрана точка START (A). Кликните второй раз — STOP (B).');
        if(clickCount==2){
          logUI('Оба маркера установлены. Отправляю на backend...');
          curB = pointsArray[1];
          const routeData = await sendPointsToBackend(pointsArray);
          if(routeData){ logUI('Маршрут получен. Запускаю анимацию.'); buildRoute(routeData); }
          else logUI('Не удалось получить маршрут. Нажмите "Сбросить точки".');
        }
        if(clickCount>=3 && isLost){
          logUI('Обновил точку ');
          pointsArray[0] = pointsArray[2];
          pointsArray.pop();
          const local_p_A = pointsArray[0]
          const local_p_B = pointsArray[1]
          isLost = false;
          clearAll();
          clickCount = 4;
          pointsArray.push(local_p_A)
          pointsArray.push(local_p_B)
          const routeData = await sendPointsToBackend(pointsArray);
          if(routeData){ logUI('Маршрут получен. Запускаю анимацию.'); buildRoute(routeData); start();}
          else logUI('Не удалось получить маршрут. Нажмите "Сбросить точки".');
        }
      });

      function buildRoute(routeData, immidiate = false){
        const pathSegments=[];
        routeData.segments.forEach(seg=>{
          const segSpeed = seg.speed_mps && seg.speed_mps>0 ? seg.speed_mps : 0.1;
          (seg.geometry_coords||[]).forEach((coord,i,arr)=>{
            if(i<arr.length-1){
              pathSegments.push({from:arr[i], to:arr[i+1], speedMps: segSpeed});
            }
          });
        });

        if(!pathSegments.length){
          logUI('Путь пуст или слишком короткий — проверьте backend');
          return;
        }

        const fullPath = pathSegments.map(s=>s.from).concat([pathSegments[pathSegments.length-1].to]);
        
        routePolylines.push(new mapgl.Polyline(map,{coordinates:fullPath,color:'#ce3838',width:5}));

        const cv=document.createElement('canvas'); cv.width=cv.height=80;
        cv.style.position='absolute'; cv.style.transform='translate(-50%,-50%)';
        const ctx=cv.getContext('2d');
        function drawPulse(r){
          ctx.clearRect(0,0,cv.width,cv.height);
          ctx.beginPath(); ctx.arc(40,40,r,0,2*Math.PI); ctx.fillStyle='rgba(206,56,56,0.4)'; ctx.fill();
          ctx.beginPath(); ctx.arc(40,40,14,0,2*Math.PI); ctx.fillStyle='rgba(206,56,56,0.9)'; ctx.fill();
        }

        animMarker = createHtmlMarker(pathSegments[0].from, cv);

        let idx = 0;
        let lastTime = performance.now();
        let lastPos = pathSegments[0].from;
        let passed = [pathSegments[0].from];

        function step(){
          if(isLost || !startAnimation) {
            animHandle = requestAnimationFrame(step);
            return;
          }
          const now = performance.now();
          const seg = pathSegments[idx];
          const segDist = getDistance(seg.from, seg.to);
          const segDuration = segDist / seg.speedMps * 1000;

          const t = Math.min((now - lastTime)/segDuration,1);
          const nx = [ seg.from[0] + (seg.to[0]-seg.from[0])*t, seg.from[1] + (seg.to[1]-seg.from[1])*t ];
          try{lastPoint.lat = nx[1];lastPoint.lon=nx[0]; animMarker.setCoordinates(nx); } catch(e){}

          drawPulse(18 + 9*(0.5 + 0.5*Math.sin(Date.now()/250)));

          const deltaDist = getDistance(lastPos,nx);
          const deltaTime = (now - lastTime)/1000;
          const speedKmh = deltaTime>0 ? (deltaDist/deltaTime)*3.6 : 0;
          speedDisplay.innerText = `Скорость: ${speedKmh.toFixed(1)} км/ч`;
        
          const fullPath = pathSegments.map(s => s.from).concat([pathSegments[pathSegments.length - 1].to]);
          const trailCoords = passed.concat([nx]);
          routePolylines.forEach(p=>{ try{p.destroy(); } catch(e){} });
            routePolylines.push(new mapgl.Polyline(map, {
            coordinates: fullPath,
            color: '#00FF00',
            width: 3,
            opacity: 0.4
          }));
        
          routePolylines.push(new mapgl.Polyline(map,{coordinates:trailCoords,color:'#ce3838',width:5}));

          if(t<1){
            requestAnimationFrame(step);
          } else {
            passed.push(seg.to);
            lastPos = seg.to;
            lastTime = performance.now();
            idx++;
            if(idx<pathSegments.length){
              requestAnimationFrame(step);
            } else {
              speedDisplay.innerText = 'Скорость: 0 км/ч';
              logUI('Анимация завершена. Нажмите "Сбросить точки".');
            }
          }
        }

        lastTime = performance.now();
        animHandle = requestAnimationFrame(step);
      }

      clearAll();
    })();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
  <script src="./script.js"></script>
</body>
</html>